<!DOCTYPE html>
<html lang="te">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Track OP | Ashwini Neuro Center</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="icon" href="./assets/images/logo.png" type="image/png" />

  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.4s ease-out; }
    .highlight { color: #1d4ed8; font-weight: bold; }
  </style>
</head>

<body class="bg-gray-50 flex flex-col items-center min-h-screen justify-center">

  <!-- üè• Header -->
  <div class="text-center mb-8 flex justify-center items-center space-x-2">
    <img src="./assets/images/logo.png" class="w-8 h-8" alt="Ashwini Neuro Center Logo">
    <h1 id="title" class="text-2xl md:text-3xl font-bold text-gray-800"></h1>
  </div>

  <!-- üîç OP Track Form -->
  <div id="trackForm" class="relative bg-white shadow-lg rounded-2xl p-6 w-11/12 md:w-1/3 fade-in text-center">
    <button onclick="goHome()" class="absolute top-3 right-3 text-gray-400 hover:text-red-500">‚úñ</button>
    <h2 id="formTitle" class="text-xl font-semibold text-gray-800 mb-4"></h2>
    <input id="opInput" type="text"
      class="w-full border-2 border-blue-300 rounded-lg px-4 py-2 mb-4 focus:outline-none focus:border-blue-500 text-center">
    <button id="trackBtn"
      class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-semibold transition"></button>
  </div>

  <!-- ‚úÖ Result Card -->
  <div id="resultCard" class="hidden relative bg-white shadow-lg rounded-2xl p-6 w-11/12 md:w-1/3 text-center fade-in">
    <button onclick="goHome()" class="absolute top-3 right-3 text-gray-400 hover:text-red-500">‚úñ</button>
    <div class="flex justify-center mb-3">
      <div class="bg-blue-100 text-blue-600 p-2 rounded-full">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      </div>
    </div>
    <h2 id="resultTitle" class="text-xl font-bold text-gray-800 mb-2"></h2>

    <p id="labelOp" class="text-gray-600 mb-1"></p>
    <p id="resultOpNumber" class="text-3xl font-bold text-blue-700 mb-4">‚Äî</p>

    <p id="labelQueue" class="text-gray-600 mb-1"></p>
    <p id="resultQueue" class="text-3xl font-bold text-gray-800 mb-4">‚Äî</p>

    <p id="labelTime" class="text-gray-600 mb-1"></p>
    <p id="resultTime" class="text-2xl font-semibold text-gray-800 mb-4">‚Äî</p>

    <button id="moreBtn"
      class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium"></button>
  </div>

  <!-- üìã More Details Card -->
  <div id="detailsCard" class="hidden relative bg-white shadow-lg rounded-2xl p-6 w-11/12 md:w-1/3 fade-in text-left overflow-y-auto max-h-[80vh]">
    <button onclick="closeDetails()" class="absolute top-3 right-3 text-gray-400 hover:text-red-500">‚úñ</button>
    <h2 id="detailsTitle" class="text-xl font-bold text-gray-800 mb-4 text-center"></h2>
    <p id="doctorName" class="text-gray-700 mb-2"></p>
    <p id="queueNumber" class="text-gray-700 mb-2"></p>
    <p id="status" class="text-gray-700 mb-4"></p>

    <h3 id="queueHeading" class="text-lg font-semibold text-gray-800 mb-2"></h3>
    <ul id="queueList" class="list-disc ml-5 space-y-1 text-gray-800"></ul>
  </div>

  <script>
    const API_URL = "https://hospital-server-p4gy.onrender.com";

    const formCard = document.getElementById("trackForm");
    const resultCard = document.getElementById("resultCard");
    const detailsCard = document.getElementById("detailsCard");

    const input = document.getElementById("opInput");
    const btn = document.getElementById("trackBtn");
    const moreBtn = document.getElementById("moreBtn");

    const resultOpNumber = document.getElementById("resultOpNumber");
    const resultQueue = document.getElementById("resultQueue");
    const resultTime = document.getElementById("resultTime");

    const doctorName = document.getElementById("doctorName");
    const queueNumber = document.getElementById("queueNumber");
    const statusEl = document.getElementById("status");
    const queueList = document.getElementById("queueList");

    const translatable = {
      title: document.getElementById("title"),
      formTitle: document.getElementById("formTitle"),
      input: document.getElementById("opInput"),
      trackBtn: document.getElementById("trackBtn"),
      resultTitle: document.getElementById("resultTitle"),
      labelOp: document.getElementById("labelOp"),
      labelQueue: document.getElementById("labelQueue"),
      labelTime: document.getElementById("labelTime"),
      moreBtn: document.getElementById("moreBtn"),
      detailsTitle: document.getElementById("detailsTitle"),
      queueHeading: document.getElementById("queueHeading"),
    };

    const translations = {
      te: {
        title: "‡∞Ö‡∞∂‡±ç‡∞µ‡∞ø‡∞®‡∞ø ‡∞®‡±ç‡∞Ø‡±Ç‡∞∞‡±ã ‡∞∏‡±Ü‡∞Ç‡∞ü‡∞∞‡±ç",
        formTitle: "‡∞Æ‡±Ä ‡∞ì‡∞™‡∞ø ‡∞ü‡±ç‡∞∞‡∞æ‡∞ï‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø",
        inputPlaceholder: "‡∞ì‡∞™‡∞ø ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç ‡∞á‡∞µ‡±ç‡∞µ‡∞Ç‡∞°‡∞ø",
        trackBtn: "‡∞ü‡±ç‡∞∞‡∞æ‡∞ï‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø",
        resultTitle: "‡∞Æ‡±Ä ‡∞ì‡∞™‡∞ø ‡∞µ‡∞ø‡∞ú‡∞Ø‡∞µ‡∞Ç‡∞§‡∞Ç‡∞ó‡∞æ ‡∞¨‡±Å‡∞ï‡±ç ‡∞ö‡±á‡∞Ø‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø",
        labelOp: "‡∞ì‡∞™‡∞ø ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç",
        labelQueue: "‡∞Æ‡±Ä ‡∞Æ‡±Å‡∞Ç‡∞¶‡±Å ‡∞â‡∞®‡±ç‡∞® ‡∞∞‡±ã‡∞ó‡±Å‡∞≤‡±Å",
        labelTime: "‡∞Ö‡∞Ç‡∞ö‡∞®‡∞æ ‡∞ï‡∞®‡±ç‡∞∏‡∞≤‡±ç‡∞ü‡±á‡∞∑‡∞®‡±ç ‡∞∏‡∞Æ‡∞Ø‡∞Ç",
        moreBtn: "‡∞Æ‡∞∞‡∞ø‡∞®‡±ç‡∞®‡∞ø ‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡±Å",
        detailsTitle: "‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡±Å",
        queueHeading: "‡∞Æ‡±Ä ‡∞Æ‡±Å‡∞Ç‡∞¶‡±Å ‡∞â‡∞®‡±ç‡∞® ‡∞ï‡±ç‡∞Ø‡±Ç‡∞≤‡±Å:",
      },
      en: {
        title: "Ashwini Neuro Center",
        formTitle: "Track Your OP",
        inputPlaceholder: "Enter OP Number",
        trackBtn: "Track OP Status",
        resultTitle: "Your OP booking is confirmed",
        labelOp: "Your OP Number",
        labelQueue: "Patients ahead of you",
        labelTime: "Expected consultation time",
        moreBtn: "More Details",
        detailsTitle: "Details",
        queueHeading: "Queue Numbers Ahead:",
      },
    };

    const lang = localStorage.getItem("userLang") || "te";
    const t = translations[lang];
    Object.keys(translatable).forEach(key => {
      if (t[key]) translatable[key].textContent = t[key];
    });
    input.placeholder = t.inputPlaceholder;

    function goHome() {
      window.location.href = "index.html";
    }

    function closeDetails() {
      detailsCard.classList.add("hidden");
      resultCard.classList.remove("hidden");
    }

    // ‚úÖ Updated showDetails() ‚Äî ignores completed & reports (case-insensitive)
    function showDetails(data, currentOp) {
      const activeData = data.filter(op => {
        const s = (op.status || "").toLowerCase();
        return s !== "completed" && s !== "report" && s !== "reports";
      });

      resultCard.classList.add("hidden");
      detailsCard.classList.remove("hidden");

      const current = activeData.find(op => op.opNumber === currentOp);
      if (!current) {
        alert(lang === "te" ? "‡∞à ‡∞ì‡∞™‡∞ø ‡∞™‡±Ç‡∞∞‡±ç‡∞§‡∞Ø‡∞ø‡∞Ç‡∞¶‡∞ø ‡∞≤‡±á‡∞¶‡∞æ ‡∞∞‡∞ø‡∞™‡±ã‡∞∞‡±ç‡∞ü‡±ç‚Äå‡∞≤‡±ã ‡∞â‡∞Ç‡∞¶‡∞ø." : "This OP is completed or in reports.");
        resultCard.classList.remove("hidden");
        detailsCard.classList.add("hidden");
        return;
      }

      const ahead = activeData.filter(op => op.queueNumber < current.queueNumber);
      const consulting = activeData.find(op => op.status === "In Consultation");

      doctorName.textContent = `${lang === "te" ? "‡∞µ‡±à‡∞¶‡±ç‡∞Ø‡±Å‡∞°‡±Å" : "Doctor"}: ${current.doctorName}`;
      queueNumber.textContent = `${lang === "te" ? "‡∞Æ‡±Ä ‡∞ï‡±ç‡∞Ø‡±Ç‡∞≤‡±ã ‡∞∏‡±ç‡∞•‡∞æ‡∞®‡∞Ç" : "Your Queue Number"}: ${current.queueNumber}`;
      statusEl.innerHTML = `${lang === "te" ? "‡∞∏‡±ç‡∞•‡∞ø‡∞§‡∞ø" : "Status"}: <span class="text-${current.status === "In Consultation" ? "blue" : "gray"}-600 font-semibold">${current.status}</span>`;

      queueList.innerHTML = "";
      ahead.forEach(op => {
        const li = document.createElement("li");
        if (consulting && consulting.queueNumber === op.queueNumber) {
          li.innerHTML = `ü©∫ <span class="highlight">${lang === "te" ? "‡∞ï‡±ç‡∞Ø‡±Ç‡∞®‡∞Ç" : "Queue No"}: ${op.queueNumber} (${lang === "te" ? "‡∞™‡±ç‡∞∞‡∞∏‡±ç‡∞§‡±Å‡∞§‡∞Ç ‡∞ï‡∞®‡±ç‡∞∏‡∞≤‡±ç‡∞ü‡∞ø‡∞Ç‡∞ó‡±ç" : "Now Consulting"})</span>`;
        } else {
          li.textContent = `${lang === "te" ? "‡∞ï‡±ç‡∞Ø‡±Ç‡∞®‡∞Ç" : "Queue No"}: ${op.queueNumber}`;
        }
        queueList.appendChild(li);
      });
    }

    // ‚úÖ Updated fetchOpStatus() ‚Äî ignores completed & reports (case-insensitive)
    async function fetchOpStatus(opNumber) {
      try {
        const res = await fetch(`${API_URL}/api/getOPs`);
        let data = await res.json();

        data = data.filter(op => {
          const s = (op.status || "").toLowerCase();
          return s !== "completed" && s !== "report" && s !== "reports";
        });

        data = data.map((op, index) => ({
          ...op,
          queueNumber: op.queueNumber || index + 1,
        }));
        data.sort((a, b) => a.queueNumber - b.queueNumber);

        const current = data.find(op => op.opNumber === opNumber);
        if (!current) {
          alert(lang === "te" ? "‡∞§‡∞™‡±ç‡∞™‡±Å ‡∞ì‡∞™‡∞ø ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç ‡∞≤‡±á‡∞¶‡∞æ ‡∞∞‡∞ø‡∞™‡±ã‡∞∞‡±ç‡∞ü‡±ç/‡∞™‡±Ç‡∞∞‡±ç‡∞§‡∞Ø‡∞ø‡∞Ç‡∞¶‡∞ø." : "Invalid OP number or already completed/report case.");
          return;
        }

        const patientsAhead = data.filter(op => op.queueNumber < current.queueNumber).length;
        const expectedTime = new Date();
        expectedTime.setMinutes(expectedTime.getMinutes() + (patientsAhead * 10));

        resultOpNumber.textContent = opNumber;
        resultQueue.textContent = patientsAhead;
        resultTime.textContent = expectedTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        formCard.classList.add("hidden");
        resultCard.classList.remove("hidden");
        moreBtn.onclick = () => showDetails(data, opNumber);
      } catch (err) {
        console.error(err);
        alert(lang === "te" ? "‡∞∏‡∞∞‡±ç‡∞µ‡∞∞‡±ç ‡∞≤‡±ã‡∞™‡∞Ç ‡∞ú‡∞∞‡∞ø‡∞ó‡∞ø‡∞Ç‡∞¶‡∞ø." : "Server error. Please try again.");
      }
    }

    btn.addEventListener("click", () => {
      const op = input.value.trim();
      if (!op) {
        alert(lang === "te" ? "‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞ì‡∞™‡∞ø ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç ‡∞á‡∞µ‡±ç‡∞µ‡∞Ç‡∞°‡∞ø." : "Please enter your OP number.");
        return;
      }
      fetchOpStatus(op);
    });

    const urlParams = new URLSearchParams(window.location.search);
    const autoOP = urlParams.get("op");
    if (autoOP) fetchOpStatus(autoOP);
  </script>
</body>
</html>
